generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id              String         @id @default(uuid())
  name            String?
  email           String         @unique
  passwordHash    String
  role            String         @default("USER")
  termsAcceptedAt DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  sessions        Session[]
  subscription    Subscription?
  payments        Payment[]
  watchProgress   WatchProgress[]
  favorites       Favorite[]
}

model Session {
  id               String    @id @default(uuid())
  userId           String
  refreshTokenHash String
  expiresAt        DateTime
  revokedAt        DateTime?
  createdAt        DateTime  @default(now())
  
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Subscription {
  id        String   @id @default(uuid())
  userId    String   @unique
  status    String   @default("INACTIVE")
  startAt   DateTime?
  endAt     DateTime?
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Payment {
  id            String   @id @default(uuid())
  userId        String
  provider      String   @default("mercadopago")
  mpPaymentId   String   @unique
  amount        Float
  planDays      Int
  status        String   @default("PENDING")
  qrCodeBase64  String?
  qrCodeText    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  paidAt        DateTime?
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model WebhookEvent {
  id          String   @id @default(uuid())
  provider    String   @default("mercadopago")
  requestId   String
  resourceId  String
  action      String
  eventKey    String   @unique
  receivedAt  DateTime @default(now())
  rawJson     String
  processedAt DateTime?
}

model PlaylistSource {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SyncLog {
  id                 String    @id @default(uuid())
  startedAt          DateTime  @default(now())
  finishedAt         DateTime?
  itemsUpserted      Int       @default(0)
  itemsInactivated   Int       @default(0)
  seriesCreated      Int       @default(0)
  episodesCreated    Int       @default(0)
  status             String
  message            String?
}

model Category {
  id        String    @id @default(uuid())
  name      String
  slug      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  movies    Movie[]
  series    Series[]
}

model Series {
  id          String    @id @default(uuid())
  externalId  String    @unique
  title       String
  posterUrl   String?
  categoryId  String
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  category    Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  episodes    Episode[]
}

model Episode {
  id             String    @id @default(uuid())
  externalId     String    @unique
  seriesId       String
  seasonNumber   Int?
  episodeNumber  Int?
  title          String
  streamUrl      String
  containerType  String    @default("UNKNOWN")
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  series         Series    @relation(fields: [seriesId], references: [id], onDelete: Cascade)
}

model Movie {
  id          String    @id @default(uuid())
  externalId  String    @unique
  title       String
  description String?
  posterUrl   String?
  categoryId  String
  streamUrl   String
  containerType String  @default("UNKNOWN")
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  category    Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  progress    WatchProgress[]
  favorites   Favorite[]
}

model WatchProgress {
  id               String   @id @default(uuid())
  userId           String
  contentType      String
  contentId        String
  positionSeconds  Int      @default(0)
  durationSeconds  Int      @default(0)
  updatedAt        DateTime @updatedAt
  
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie            Movie?   @relation(fields: [contentId], references: [id], onDelete: Cascade)
  
  @@unique([userId, contentType, contentId])
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  contentType String
  contentId String
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie     Movie?   @relation(fields: [contentId], references: [id], onDelete: Cascade)
  
  @@unique([userId, contentType, contentId])
}

model MediaVariant {
  id            String   @id @default(uuid())
  contentType   String
  contentId     String
  sourceUrl     String
  variantType   String
  status        String   @default("PENDING")
  outputPath    String?
  lastError     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([contentType, contentId, variantType])
}
